name: Build and Release Python Archives

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag name'
        required: true
        default: 'latest'

permissions:
  contents: write

jobs:
  build-python:
    name: Build ${{ matrix.python_version }} on ${{ matrix.os-name }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux x64 ---
          - os: ubuntu-latest
            os-name: 'linux'
            arch: x86_64
            python_version: '2.7.18'
          - os: ubuntu-latest
            os-name: 'linux'
            arch: x86_64
            python_version: '3.13.1'
            
          # --- Linux ARM64 (native ARM64 runner) ---
          - os: ubuntu-24.04-arm
            os-name: 'linux'
            arch: aarch64
            python_version: '2.7.18'
          - os: ubuntu-24.04-arm
            os-name: 'linux'
            arch: aarch64
            python_version: '3.13.1'
            
          # --- macOS x64 (via Rosetta 2 on ARM64 runner) ---
          # GitHub 已淘汰所有 Intel macOS 运行器 (macos-12/13)
          # 使用 macos-latest (ARM64) + Rosetta 2 模拟 x86_64
          - os: macos-latest
            os-name: 'macos'
            arch: x86_64
            python_version: '2.7.18'
          - os: macos-latest
            os-name: 'macos'
            arch: x86_64
            python_version: '3.13.1'
            
          # --- macOS ARM64 (Apple Silicon) ---
          - os: macos-latest
            os-name: 'macos'
            arch: arm64
            python_version: '2.7.18'
          - os: macos-latest
            os-name: 'macos'
            arch: arm64
            python_version: '3.13.1'
            
          # --- Windows x64 ---
          - os: windows-latest
            os-name: 'windows'
            arch: x86_64
            python_version: '3.13.1'
            
          # --- Windows ARM64 (Cross-compile) ---
          - os: windows-latest
            os-name: 'windows'
            arch: arm64
            python_version: '3.13.1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Standard Setup & Build ---
      
      - name: Set up dependencies (Linux)
        if: matrix.os-name == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev zlib1g-dev \
            libncurses5-dev libncursesw5-dev libreadline-dev libsqlite3-dev \
            libgdbm-dev libdb5.3-dev libbz2-dev libexpat1-dev liblzma-dev \
            tk-dev libffi-dev wget

      - name: Set up dependencies (macOS)
        if: matrix.os-name == 'macos'
        run: |
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            echo "Installing Rosetta 2 for x86_64 emulation..."
            sudo softwareupdate --install-rosetta --agree-to-license || true
            
            # 安装 x86_64 版本的 Homebrew（安装到 /usr/local）
            echo "Installing x86_64 Homebrew..."
            arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" </dev/null
            
            # 用 x86_64 Homebrew 安装 x86_64 版本的依赖
            BREW_X86="/usr/local/bin/brew"
            arch -x86_64 $BREW_X86 install readline sqlite3 xz zlib tcl-tk
            if [[ "${{ matrix.python_version }}" == 2.* ]]; then
              arch -x86_64 $BREW_X86 install openssl@1.1
            else
              arch -x86_64 $BREW_X86 install openssl@3
            fi
          else
            # ARM64 原生构建，使用默认 Homebrew
            brew install readline sqlite3 xz zlib tcl-tk
            if [[ "${{ matrix.python_version }}" == 2.* ]]; then
              brew install openssl@1.1
            else
              brew install openssl@3
            fi
          fi

      - name: Set up dependencies (Windows)
        if: matrix.os-name == 'windows'
        shell: bash
        run: |
          which msbuild.exe || where.exe msbuild || echo "MSBuild not found"

      - name: Build Python
        shell: bash
        env:
          TARGET_ARCH: ${{ matrix.arch }}
        run: |
          # macOS x86_64：通过 Rosetta 2 运行整个构建
          if [[ "${{ matrix.os-name }}" == "macos" && "${{ matrix.arch }}" == "x86_64" ]]; then
            echo "Building under Rosetta 2 (arch -x86_64)..."
            arch -x86_64 bash ./scripts/build-python.sh ${{ matrix.python_version }}
          else
            bash ./scripts/build-python.sh ${{ matrix.python_version }}
          fi

      - name: Create archive
        shell: bash
        run: |
          cd dist
          if [ "${{ matrix.os-name }}" = "windows" ]; then
            7z a python-${{ matrix.python_version }}-windows-${{ matrix.arch }}.zip python-${{ matrix.python_version }}/
          else
            # Use matrix.arch explicitly
            tar czf python-${{ matrix.python_version }}-${{ matrix.os-name }}-${{ matrix.arch }}.tar.gz python-${{ matrix.python_version }}/
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ matrix.python_version }}-${{ matrix.os-name }}-${{ matrix.arch }}
          path: |
            dist/*.tar.gz
            dist/*.zip
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-python
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat << EOF > release-notes.md
          # Python Archive Release ${{ steps.get_tag.outputs.tag }}
          
          This release includes standalone Python distributions for multiple platforms.
          
          ## Included Python Versions
          - Python 2.7.18 (最后的 Python 2 版本)
          - Python 3.13.1 (最新的 Python 3 稳定版)
          
          ## Platforms
          - Linux (x86_64, aarch64)
          - macOS (x86_64, arm64)
          - Windows (x86_64, arm64)
          
          ## Usage
          Download the appropriate archive for your platform and extract it:
          
          **Linux/macOS:**
          \`\`\`bash
          tar xzf python-<version>-<platform>-<arch>.tar.gz
          cd python-<version>
          ./bin/python --version
          \`\`\`
          
          **Windows:**
          \`\`\`powershell
          Expand-Archive python-<version>-windows-<arch>.zip
          cd python-<version>
          python.exe --version
          \`\`\`
          
          ## Checksums
          SHA256 checksums for verification:
          \`\`\`
          $(cd release-assets && sha256sum * 2>/dev/null || shasum -a 256 *)
          \`\`\`
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Python Archive ${{ steps.get_tag.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate checksums file
        run: |
          cd release-assets
          sha256sum * > SHA256SUMS.txt 2>/dev/null || shasum -a 256 * > SHA256SUMS.txt

      - name: Upload checksums
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          files: release-assets/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
